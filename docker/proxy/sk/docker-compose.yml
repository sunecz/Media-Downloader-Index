services:
  proxy_sk-squid:
    image: ubuntu/squid:latest
    container_name: "proxy_sk-squid"
    restart: unless-stopped
    network_mode: service:proxy_sk-wireguard
    depends_on:
      - proxy_sk-wireguard
    volumes:
      - "${PROXY_SK_DIRECTORY}/default.html:/usr/share/squid/errors/templates/ERR_INVALID_URL:ro"
      - "${PROXY_SK_DIRECTORY}/squid.conf:/etc/squid/squid.conf:ro"

  proxy_sk-wireguard:
    image: lscr.io/linuxserver/wireguard:latest
    container_name: "proxy-sk"
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - /lib/modules:/lib/modules
      - "${PROXY_SK_DIRECTORY}/wireguard/wg0.conf:/config/wg_confs/wg0.conf:ro"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv6.conf.all.disable_ipv6=0
    networks:
      - net-wireguard-proxy_sk
      - net-mdi
    ports:
      - "127.0.0.1:${PROXY_SK_PORT}:3128/tcp"

networks:
  net-wireguard-proxy_sk:
  net-mdi:
    external: true
